# @Bybyscan 2024
# Разработчик не гарантирует работу кода, это макет, который работал с ChadGPT- посредником OpenAI.
# Код опубликован в качестве примера логики.

```markdown
# Описание работы Telegram-бота с интеграцией ChatGPT

## Общая информация
- **Версия**: HR 14.01.2025 (Telegram 3.0, 26/12/2024)
- **Бот**: (https://t.me/your_bot)
- **Webhook URL**: `https://yoursite.ru/hrbot.php`
- **Используемые технологии**:
  - PHP
  - Библиотека `longman/telegram-bot`
  - API ChadGPT (`ask.chadgpt.ru/api/public/gpt-4o-mini`)

---

## Основной алгоритм работы
1. **Инициализация**:
   - Подключение библиотек Telegram Bot API
   - Запуск фоновых задач очистки истории (`updateHistory()`)

2. **Обработка входящих сообщений**:
   - Сохранение сырых данных в `tgdata.json`
   - Парсинг JSON для извлечения:
     - Текста сообщения
     - Chat ID
     - Юзернейма
     - Message ID

3. **Подготовка контекста**:
   - Очистка текста от нежелательных символов (`clean()`)
   - Формирование истории диалога:
     - Добавление новых сообщений в историю (`add1()`)
     - Инициализация истории из шаблона (`add()`)

4. **Взаимодействие с ChatGPT**:
   - Отправка запроса через cURL
   - Обработка ответа:
     - Проверка на ошибки API (`aierror()`)
     - Очистка ответа от лишних символов (`parser()`)

5. **Отправка ответа пользователю**:
   - Персонализация ответа (10% случаев) (`counter()`)
   - Отправка через Telegram API (`sendmessage()`)

---

## Ключевые функции

### `tghandler()`
- **Назначение**: Обработка входящих сообщений Telegram
- **Действия**:
  - Парсинг JSON-данных
  - Сохранение ключевых параметров в файлы:
    - `tgpost.txt` - текст сообщения
    - `tgchat_id.txt` - идентификатор чата
    - `tgname.txt` - юзернейм пользователя

### `ch_chad()`
- **Назначение**: Взаимодействие с API ChadGPT
- **Параметры запроса**:
  ```php
  {
    "message": "текст сообщения",
    "temperature": 0.1,
    "max_tokens": 100,
    "api_key": "ключ из key.txt",
    "history": [история диалога]
  }
  ```

### `parser()`
- **Назначение**: Обработка ответа от ChatGPT
- **Особенности**:
  - Удаление недопустимых символов через регулярное выражение
  - Сохранение очищенного текста в `chatgptanswer.txt`

### `updateHistory()`
- **Назначение**: Управление историей диалогов
- **Логика**:
  - Автоматическая очистка истории при отсутствии активности >1 часа
  - Использование шаблона из `brief.txt` для инициализации

---

## Особенности реализации
1. **Хранение данных**:
   - Все промежуточные данные сохраняются в текстовые файлы
   - Используется структура каталогов `./var/`

2. **Обработка ошибок**:
   - Проверка кодов ошибок ChadGPT (AE-447, AE-448, AE-449)
   - Очистка ошибочных ответов

3. **Оптимизации**:
   - Таймауты cURL: 0.5 секунды
   - Температура генерации: 0.1 для детерминированности
   - Максимальная длина ответа: 100 токенов

4. **Персонализация**:
   - Случайное добавление юзернейма в ответ (25% вероятность)

---

## Требования к системе
- PHP 7.4+
- Доступ к API ChadGPT
- Разрешения на запись в директорию `./var/`
- Установленные зависимости через Composer:
  - `longman/telegram-bot`

---

